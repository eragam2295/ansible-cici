---
- hosts: webservers
  become: yes
  tasks:
  - name: Install java8
    yum:
      name: java-1.8.0-openjdk
      state: present
  - name: download tomcat8
    get_url:
      url: https://dlcdn.apache.org/tomcat/tomcat-8/v8.5.78/bin/apache-tomcat-8.5.78.tar.gz
      dest: /opt/
  - name: check /opt/tomcat8 folder is present
    stat:
      path: /opt/tomcat8
    register: st
  - name: task to unzip zip file using tar
    unarchive:
      src: /opt/apache-tomcat-8.5.78.tar.gz
      dest: /opt
      remote_src: yes
    when: not st.stat.exists
  - name: rename the folder
    copy:
      src: /opt/apache-tomcat-8.5.78/
      dest: /opt/
      remote_src: True
      owner: ec2-user
      group: ec2-user
    when: not st.stat.exists
  - name: remove unwanted files and folders
    file:
      path: /opt/apache-tomcat-8.5.78
      state: absent

  - name: Change file ownership, group and permissions
    file:
      path: /opt/apache-tomcat-8.5.78
      owner: ec2-user
      mode: '0777'

  - name: start and enable tomcat server
    service:
      name: tomcat
      state: started
      enabled: yes

  - name: deploy sample app
    copy:
      src: target/maven-archetype-webapp
      dest: /opt/tomcat8/webapps/
      owner: ec2-user
      group: ec2-user
